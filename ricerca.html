<div class="flex flex-col h-screen overflow-hidden">
    <div class="flex justify-between items-start mb-4 shrink-0 px-2">
        <div>
            <h1 class="text-2xl font-bold text-slate-900">Parco Impianti</h1>
            <p class="text-slate-500 text-sm">King Portal - Database Integrato</p>
        </div>
        <div id="debugPanel" class="hidden md:block bg-slate-800 text-white p-2 rounded-lg text-[10px] font-mono border border-slate-700 min-w-[200px]">
            <div class="flex justify-between border-b border-slate-700 pb-1 mb-1">
                <span class="text-slate-400 uppercase">Stato:</span>
                <span id="dbStatusText" class="text-amber-400 font-bold">AVVIO...</span>
            </div>
            <div id="debugStats" class="text-blue-300"></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-1 min-h-0">
        <div class="lg:col-span-4 flex flex-col min-h-0 space-y-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 shrink-0">
                <form id="searchForm" class="space-y-3">
                    <input type="text" id="query" placeholder="ID (E8Y...) o Indirizzo..." 
                           class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm font-medium">
                    <button type="submit" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md active:scale-95 uppercase text-xs">Cerca</button>
                </form>
            </div>
            <div id="results" class="flex-1 overflow-y-auto pr-2 space-y-2 no-scrollbar pb-24">
                <div class="text-center py-10 text-slate-300 italic text-sm">Pronto per la ricerca</div>
            </div>
        </div>

        <div class="hidden lg:block lg:col-span-8 overflow-y-auto no-scrollbar pb-4 h-full">
            <div id="desktopDetailArea" class="bg-white rounded-3xl shadow-sm border border-slate-100 min-h-full p-10 text-center flex flex-col items-center justify-center text-slate-300">
                <i class="fas fa-elevator text-5xl mb-4 opacity-10"></i>
                <p>Seleziona un impianto per i dettagli</p>
            </div>
        </div>
    </div>
</div>

<div id="mobileModal" class="fixed inset-0 z-[100] hidden lg:hidden">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal()"></div>
    <div id="modalContainer" class="absolute bottom-0 left-0 right-0 top-16 bg-white rounded-t-[2.5rem] shadow-2xl flex flex-col transform translate-y-full transition-transform duration-300">
        <div class="w-full flex justify-center py-4 shrink-0" onclick="closeModal()"><div class="w-12 h-1.5 bg-slate-200 rounded-full"></div></div>
        <div id="mobileDetailArea" class="flex-1 overflow-y-auto p-6 no-scrollbar pb-24"></div>
        <div class="p-4 bg-white border-t shrink-0 text-center"><button onclick="closeModal()" class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl">CHIUDI</button></div>
    </div>
</div>

<div id="subModal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" onclick="closeSubModal()"></div>
    <div class="relative bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden">
        <div class="p-6 border-b flex justify-between items-center bg-slate-50">
            <h3 id="subModalTitle" class="text-lg font-black text-slate-900 uppercase tracking-tighter">Dettagli</h3>
            <button onclick="closeSubModal()" class="text-slate-400 hover:text-red-500"><i class="fas fa-times-circle text-xl"></i></button>
        </div>
        <div id="subModalContent" class="p-8 text-sm text-slate-700 space-y-6 max-h-[70vh] overflow-y-auto"></div>
    </div>
</div>

<script>
    // 1. DEFINIZIONE FUNZIONE DEBUG (SOLUZIONE AL REFERENCE ERROR)
    function updateDebug(status, stats = "") {
        const s = document.getElementById('dbStatusText');
        const d = document.getElementById('debugStats');
        if (s) s.textContent = status;
        if (d) d.innerHTML = stats;
    }

    var db = { parco: [], m28: [], mappature: { comm: {}, giri: {} }, archivio: [], verbali: [], annotazioni: [], commesse: [] };

    // Utility
    const excelToDate = (ed) => (ed && !isNaN(ed)) ? new Date(Math.round((ed - 25569) * 86400 * 1000)) : null;
    const formatDate = (date) => date ? date.toLocaleDateString('it-IT') : '---';
    const diffDays = (ed) => (ed && !isNaN(ed)) ? Math.floor((new Date() - excelToDate(ed)) / (1000 * 60 * 60 * 24)) : null;

    // Inizializzazione
    async function initDatabase() {
        try {
            updateDebug("CARICAMENTO...");
            const response = await fetch('./database/DB.xlsx'); // Percorso relativo per GitHub
            if (!response.ok) throw new Error("File DB.xlsx non trovato in /database/");
            
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            
            db.parco = XLSX.utils.sheet_to_json(workbook.Sheets["PARCO"] || []);
            db.m28 = XLSX.utils.sheet_to_json(workbook.Sheets["M28"] || []);
            db.archivio = XLSX.utils.sheet_to_json(workbook.Sheets["ARCHIVIO"] || []);
            db.verbali = XLSX.utils.sheet_to_json(workbook.Sheets["ELENCO"] || []);
            db.annotazioni = XLSX.utils.sheet_to_json(workbook.Sheets["ANNOTAZIONI"] || []);
            db.commesse = XLSX.utils.sheet_to_json(workbook.Sheets["Gestione Commesse Q2SA BO"] || []);
            
            const mapData = XLSX.utils.sheet_to_json(workbook.Sheets["MAPPATURE"] || []);
            mapData.forEach(row => {
                if (row.Tipo === 'COMMERCIALE') db.mappature.comm[row.Codice] = row.Nome;
                if (row.Tipo === 'GIRO') db.mappature.giri[row.Codice] = row.Nome;
            });

            updateDebug("PRONTO", `Record: ${db.parco.length}`);
            document.getElementById('dbStatusText').className = "text-emerald-400 font-bold";
        } catch (err) {
            updateDebug("ERRORE", err.message);
        }
    }

    // Ricerca
    document.getElementById('searchForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const q = document.getElementById('query').value.toLowerCase().trim();
        if (q.length < 3) return;
        const results = db.parco.filter(item => 
            String(item.impianto).toLowerCase().includes(q) || 
            String(item['Indirizzo impianto']).toLowerCase().includes(q)
        );
        renderResults(results);
    });

    function renderResults(list) {
        const container = document.getElementById('results');
        container.innerHTML = list.length ? '' : '<div class="p-10 text-slate-300 italic">Nessun risultato</div>';
        list.slice(0, 50).forEach(item => {
            const card = document.createElement('div');
            card.className = "bg-white p-4 rounded-xl border border-slate-200 hover:border-blue-500 cursor-pointer shadow-sm active:scale-95 transition-all group";
            card.onclick = () => showDetails(item);
            card.innerHTML = `
                <div class="flex justify-between items-center text-left">
                    <div>
                        <div class="text-[10px] font-black text-blue-600 uppercase">${item.impianto}</div>
                        <div class="text-sm font-bold text-slate-800 leading-tight">${item['Indirizzo impianto']}</div>
                        <div class="text-[10px] text-slate-400 font-bold mt-0.5 uppercase">${item['Localit√† impianto']}</div>
                    </div>
                    <i class="fas fa-chevron-right text-slate-200 group-hover:text-blue-500"></i>
                </div>`;
            container.appendChild(card);
        });
    }

    function showDetails(imp) {
        const html = generateDetailHTML(imp);
        if (window.innerWidth < 1024) {
            document.getElementById('mobileDetailArea').innerHTML = html;
            document.getElementById('mobileModal').classList.remove('hidden');
            setTimeout(() => { document.getElementById('modalContainer').style.transform = "translateY(0)"; }, 10);
        } else {
            const area = document.getElementById('desktopDetailArea');
            area.className = "bg-white rounded-3xl shadow-sm border border-slate-100 p-8 text-left h-full overflow-y-auto no-scrollbar scroll-smooth";
            area.innerHTML = html;
        }
    }

    function closeModal() {
        document.getElementById('modalContainer').style.transform = "translateY(100%)";
        setTimeout(() => { document.getElementById('mobileModal').classList.add('hidden'); }, 300);
    }

    function openSubModal(title, content) {
        document.getElementById('subModalTitle').textContent = title;
        document.getElementById('subModalContent').innerHTML = content;
        document.getElementById('subModal').classList.remove('hidden');
    }

    function closeSubModal() { document.getElementById('subModal').classList.add('hidden'); }

    // Funzioni Info
    function showCommessaInfo(idx) {
        const c = db.commesse[idx];
        const html = `<div class="space-y-4">
            <div class="bg-blue-50 p-4 rounded-xl"><b>${c['Numero Commessa']}</b></div>
            <p>Supervisore: <b>${c['Supervisore STF'] || '---'}</b></p>
            <p>Commerciale: <b>${c['Addetto commerciale'] || '---'}</b></p>
            <p>Lavori: ${c['Descrizione Lavori'] || '---'}</p>
        </div>`;
        openSubModal("Info Commessa", html);
    }

    function showDcInfo(idx) {
        const d = db.archivio[idx];
        const html = `<div class="space-y-4">
            <p>Pratica: <b>${d['N¬∞  PRATICA ARCHIVIO']}</b></p>
            <p>Tipo: ${d['TIPO LAVORO'] || '---'}</p>
            <p>Documenti: <b>${d['DOC RICHIESTI'] || '---'}</b></p>
        </div>`;
        openSubModal("Dettaglio DC", html);
    }

    function generateDetailHTML(imp) {
        const semGG = diffDays(imp['ult sem']);
        const vpGG = diffDays(imp['utl vp']);
        const ann = db.annotazioni.filter(a => String(a.impianto_ann) == String(imp.impianto));
        const verb = db.verbali.filter(v => String(v.IMPIANTO) == String(imp.impianto));
        const dcList = db.archivio.map((v, i) => ({...v, oIdx: i})).filter(a => String(a['N¬∞IMPIANTO ESA']) == String(imp.impianto));
        const commList = db.commesse.map((v, i) => ({...v, oIdx: i})).filter(c => String(c['ID Imp.']) == String(imp.impianto));

        return `<div class="space-y-8 pb-10">
            <h2 class="text-4xl font-black text-slate-900">${imp.impianto} üìù</h2>
            <p class="text-xl font-bold text-slate-700">${imp['Indirizzo impianto']} (${imp['Localit√† impianto']})</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-4 bg-slate-50 rounded-xl">
                    <span class="text-[10px] uppercase font-bold text-slate-400">Responsabili</span>
                    <p class="text-xs mt-2">Giro: <b>${db.mappature.giri[imp.giro] || imp.giro}</b></p>
                    <p class="text-xs">Comm: <b>${db.mappature.comm[imp.venditore] || imp.venditore}</b></p>
                </div>
                <div class="p-4 rounded-xl border ${semGG > 180 ? 'bg-red-50' : 'bg-blue-50'}">
                    <span class="text-[10px] uppercase font-bold opacity-50">Semestrale</span>
                    <p class="text-sm font-bold">${formatDate(excelToDate(imp['ult sem']))} [${semGG} gg]</p>
                </div>
                <div class="p-4 bg-amber-50 rounded-xl">
                    <span class="text-[10px] uppercase font-bold opacity-50">Visita Ente</span>
                    <p class="text-sm font-bold">${formatDate(excelToDate(imp['utl vp']))} [${vpGG} gg]</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl border border-slate-200">
                <p class="text-sm">Cliente: <b>${imp.Cliente || '---'}</b></p>
                <p class="text-xs text-blue-600">Amministratore: ${imp.Amministratore || '---'}</p>
                <div class="mt-4 p-3 bg-slate-50 rounded text-xs italic">Note: ${imp.note || 'Nessuna'}</div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white p-4 border rounded-xl">
                    <h4 class="text-[10px] font-bold uppercase mb-2">Commesse</h4>
                    ${commList.map(c => `<div class="flex justify-between items-center bg-amber-50 p-1 mb-1 rounded text-[10px]"><span>${c['Numero Commessa']}</span><button onclick="event.stopPropagation(); showCommessaInfo(${c.oIdx})" class="bg-amber-600 text-white px-2 rounded">INFO</button></div>`).join('') || '---'}
                </div>
                <div class="bg-white p-4 border rounded-xl">
                    <h4 class="text-[10px] font-bold uppercase mb-2">Archivio DC</h4>
                    ${dcList.map(d => `<div class="flex justify-between items-center bg-emerald-50 p-1 mb-1 rounded text-[10px]"><span>PR. ${d['N¬∞  PRATICA ARCHIVIO']}</span><button onclick="event.stopPropagation(); showDcInfo(${d.oIdx})" class="bg-emerald-600 text-white px-2 rounded">INFO</button></div>`).join('') || '---'}
                </div>
            </div>
        </div>`;
    }

    initDatabase();
</script>
 
