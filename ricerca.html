<div class="flex flex-col h-screen overflow-hidden">
    <div class="flex justify-between items-start mb-4 shrink-0 px-2 md:px-0">
        <div>
            <h1 class="text-2xl font-bold text-slate-900">Parco Impianti</h1>
            <p class="text-slate-500 text-sm">King Portal - Gestione Totale</p>
        </div>
        <div id="debugPanel" class="hidden md:block bg-slate-800 text-white p-2 rounded-lg text-[10px] font-mono border border-slate-700">
            <span id="dbStatusText" class="text-amber-400 font-bold uppercase tracking-tighter">Inizializzazione...</span>
            <div id="debugStats" class="text-blue-300"></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-1 min-h-0">
        <div class="lg:col-span-4 flex flex-col min-h-0 space-y-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 shrink-0">
                <form id="searchForm" class="space-y-3">
                    <div class="relative">
                        <input type="text" id="query" placeholder="ID o Indirizzo..." 
                               class="w-full p-3 pl-10 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm font-medium">
                        <i class="fas fa-search absolute left-3 top-3.5 text-slate-400"></i>
                    </div>
                    <button type="submit" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-all shadow-md active:scale-95 uppercase text-xs tracking-widest">Avvia Ricerca</button>
                </form>
            </div>

            <div id="results" class="flex-1 overflow-y-auto pr-2 space-y-2 no-scrollbar pb-24 md:pb-4">
                <div class="text-center py-20 text-slate-300 italic text-sm">Pronto per la ricerca</div>
            </div>
        </div>

        <div class="hidden lg:block lg:col-span-8 overflow-y-auto no-scrollbar pb-4 h-full">
            <div id="desktopDetailArea" class="bg-white rounded-3xl shadow-sm border border-slate-100 min-h-full p-10 text-center flex flex-col items-center justify-center text-slate-300">
                <i class="fas fa-elevator text-5xl mb-4 opacity-10"></i>
                <p>Seleziona un impianto per caricare la scheda tecnica</p>
            </div>
        </div>
    </div>
</div>

<div id="mobileModal" class="fixed inset-0 z-[100] hidden lg:hidden">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal()"></div>
    <div id="modalContainer" class="absolute bottom-0 left-0 right-0 top-16 bg-white rounded-t-[2.5rem] shadow-2xl flex flex-col transform translate-y-full transition-transform duration-300">
        <div class="w-full flex justify-center py-4 shrink-0" onclick="closeModal()">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full"></div>
        </div>
        <div id="mobileDetailArea" class="flex-1 overflow-y-auto p-6 no-scrollbar pb-24"></div>
        <div class="p-4 border-t border-slate-100 bg-white shrink-0">
            <button onclick="closeModal()" class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-lg">CHIUDI SCHEDA</button>
        </div>
    </div>
</div>

<div id="subModal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" onclick="closeSubModal()"></div>
    <div class="relative bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
            <h3 id="subModalTitle" class="text-lg font-black text-slate-900 uppercase">Dettagli</h3>
            <button onclick="closeSubModal()" class="text-slate-400 hover:text-red-500 transition-colors"><i class="fas fa-times-circle text-xl"></i></button>
        </div>
        <div id="subModalContent" class="p-8 text-sm text-slate-700 space-y-6 max-h-[70vh] overflow-y-auto"></div>
    </div>
</div>

<script>
    var db = { parco: [], m28: [], mappature: { comm: {}, giri: {} }, archivio: [], verbali: [], annotazioni: [], commesse: [] };

    const excelToDate = (ed) => (ed && !isNaN(ed)) ? new Date(Math.round((ed - 25569) * 86400 * 1000)) : null;
    const formatDate = (date) => date ? date.toLocaleDateString('it-IT') : '---';
    const diffDays = (ed) => {
        if (!ed || isNaN(ed)) return null;
        return Math.floor((new Date() - excelToDate(ed)) / (1000 * 60 * 60 * 24));
    };

    async function initDatabase() {
       try {
        updateDebug("FETCHING...");
        
        // Usiamo un timestamp per evitare che GitHub Pages serva una versione vecchia (cache)
        const dbPath = `database/DB.xlsx?v=${new Date().getTime()}`;
        
        const response = await fetch(dbPath);
        
        if (!response.ok) {
            throw new Error(`File non trovato al percorso: ${dbPath}`);
        }
        
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            
            db.parco = XLSX.utils.sheet_to_json(workbook.Sheets["PARCO"] || []);
            db.m28 = XLSX.utils.sheet_to_json(workbook.Sheets["M28"] || []);
            db.archivio = XLSX.utils.sheet_to_json(workbook.Sheets["ARCHIVIO"] || []);
            db.verbali = XLSX.utils.sheet_to_json(workbook.Sheets["ELENCO"] || []);
            db.annotazioni = XLSX.utils.sheet_to_json(workbook.Sheets["ANNOTAZIONI"] || []);
            db.commesse = XLSX.utils.sheet_to_json(workbook.Sheets["Gestione Commesse Q2SA BO"] || []);
            
            const mapData = XLSX.utils.sheet_to_json(workbook.Sheets["MAPPATURE"] || []);
            mapData.forEach(row => {
                if (row.Tipo === 'COMMERCIALE') db.mappature.comm[row.Codice] = row.Nome;
                if (row.Tipo === 'GIRO') db.mappature.giri[row.Codice] = row.Nome;
            });

            document.getElementById('dbStatusText').textContent = "PORTALE PRONTO";
            document.getElementById('dbStatusText').className = "text-emerald-400 font-bold";
            document.getElementById('debugStats').innerHTML = `Impianti: ${db.parco.length} | Commesse: ${db.commesse.length}`;
      } catch (err) {
        console.error("Errore Caricamento DB:", err);
        updateDebug("ERRORE");
        document.getElementById('debugStats').innerHTML = `<div class="text-red-400 text-[10px]">${err.message}</div>`;
    }
    }

    document.getElementById('searchForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const q = document.getElementById('query').value.toLowerCase().trim();
        if (q.length < 3) return;
        const results = db.parco.filter(item => 
            String(item.impianto).toLowerCase().includes(q) || 
            String(item['Indirizzo impianto']).toLowerCase().includes(q)
        );
        renderResults(results);
    });

    function renderResults(list) {
        const container = document.getElementById('results');
        container.innerHTML = list.length ? '' : '<div class="p-10 text-slate-300 italic">Nessun risultato</div>';
        list.slice(0, 50).forEach(item => {
            const card = document.createElement('div');
            card.className = "bg-white p-4 rounded-xl border border-slate-200 hover:border-blue-500 cursor-pointer shadow-sm active:scale-95 transition-all group";
            card.onclick = () => showDetails(item);
            card.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-[10px] font-black text-blue-600 uppercase">${item.impianto}</div>
                        <div class="text-sm font-bold text-slate-800 leading-tight">${item['Indirizzo impianto']}</div>
                        <div class="text-[10px] text-slate-400 font-bold mt-0.5 uppercase">${item['Localit√† impianto']}</div>
                    </div>
                    <i class="fas fa-chevron-right text-slate-200 group-hover:text-blue-500"></i>
                </div>`;
            container.appendChild(card);
        });
    }

    function showDetails(imp) {
        const html = generateDetailHTML(imp);
        if (window.innerWidth < 1024) {
            document.getElementById('mobileDetailArea').innerHTML = html;
            document.getElementById('mobileModal').classList.remove('hidden');
            setTimeout(() => { document.getElementById('modalContainer').style.transform = "translateY(0)"; }, 10);
        } else {
            const area = document.getElementById('desktopDetailArea');
            area.className = "bg-white rounded-3xl shadow-sm border border-slate-100 p-8 text-left h-full overflow-y-auto no-scrollbar scroll-smooth";
            area.innerHTML = html;
        }
    }

    function closeModal() {
        document.getElementById('modalContainer').style.transform = "translateY(100%)";
        setTimeout(() => { document.getElementById('mobileModal').classList.add('hidden'); }, 300);
    }

    function openSubModal(title, content) {
        document.getElementById('subModalTitle').textContent = title;
        document.getElementById('subModalContent').innerHTML = content;
        document.getElementById('subModal').classList.remove('hidden');
    }

    function closeSubModal() { document.getElementById('subModal').classList.add('hidden'); }

    // DETTAGLI INFO
    function showCommessaInfo(idx) {
        const c = db.commesse[idx];
        const html = `
            <div class="space-y-6">
                <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                    <span class="text-[10px] font-black text-blue-400 uppercase">Numero Commessa</span>
                    <p class="font-black text-blue-800 text-2xl">${c['Numero Commessa']}</p>
                </div>
                <div class="grid grid-cols-2 gap-4 text-xs">
                    <div><span class="font-bold text-slate-400 uppercase">Apertura:</span><br><b>${formatDate(excelToDate(c['Data commessa']))}</b></div>
                    <div><span class="font-bold text-slate-400 uppercase">Stato:</span><br><b>${c['Stato comm.'] === 'C' ? 'CHIUSA' : 'IN CORSO'}</b></div>
                    <div><span class="font-bold text-slate-400 uppercase">Supervisore STF:</span><br><b>${c['Supervisore STF'] || '---'}</b></div>
                    <div><span class="font-bold text-slate-400 uppercase">Addetto Commerciale:</span><br><b>${c['Addetto commerciale'] || '---'}</b></div>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl">
                    <span class="text-[10px] font-black text-slate-400 uppercase">Descrizione Lavori</span>
                    <p class="font-medium mt-1">${c['Descrizione Lavori'] || '---'}</p>
                </div>
                <p class="text-[11px] italic text-slate-400 border-t pt-2">Note: ${c['NOTE'] || 'Nessuna'}</p>
            </div>`;
        openSubModal("Info Commessa", html);
    }

    function showDcInfo(idx) {
        const d = db.archivio[idx];
        const html = `
            <div class="space-y-4">
                <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100 text-center">
                    <span class="text-[10px] font-black text-emerald-500 uppercase">N¬∞ Pratica</span>
                    <p class="text-3xl font-black text-emerald-800">${d['N¬∞  PRATICA ARCHIVIO']}</p>
                </div>
                <div class="text-xs space-y-2">
                    <p><span class="font-bold text-slate-400 uppercase">Lavoro:</span> ${d['TIPO LAVORO'] || '---'}</p>
                    <p><span class="font-bold text-slate-400 uppercase">Stato:</span> ${d['STATO PRATICA'] || '---'}</p>
                    <div class="bg-slate-50 p-3 rounded-lg"><span class="font-bold text-slate-400 uppercase text-[9px]">Documenti Richiesti:</span><br><b>${d['DOC RICHIESTI'] || '---'}</b></div>
                </div>
            </div>`;
        openSubModal("Dettaglio DC", html);
    }

    function generateDetailHTML(imp) {
        const semGG = diffDays(imp['ult sem']);
        const vpGG = diffDays(imp['utl vp']);
        const ann = db.annotazioni.filter(a => a.impianto_ann == imp.impianto);
        const verb = db.verbali.filter(v => v.IMPIANTO == imp.impianto);
        // Filtraggio corretto DC e Commesse
        const dcList = db.archivio.map((v, i) => ({...v, idx: i})).filter(a => String(a['N¬∞IMPIANTO ESA']) == String(imp.impianto));
        const commList = db.commesse.map((v, i) => ({...v, idx: i})).filter(c => String(c['ID Imp.']) == String(imp.impianto));

        return `
            <div class="space-y-8 pb-20">
                <div class="flex flex-col md:flex-row justify-between items-start border-b border-slate-100 pb-6 gap-4">
                    <div class="space-y-2">
                        <h2 class="text-5xl font-black text-slate-900 tracking-tighter">${imp.impianto} <span class="text-2xl">üìù</span></h2>
                        <p class="text-xl font-bold text-slate-700">${imp['Indirizzo impianto']}</p>
                        <p class="text-slate-400 font-black uppercase text-xs">${imp['Localit√† impianto']} - Zona ${imp.zona}</p>
                    </div>
                    <div class="bg-slate-900 text-white p-5 rounded-3xl min-w-[200px] text-center shadow-xl">
                        <span class="block text-[10px] uppercase opacity-40 font-bold mb-1">Matricola</span>
                        <span class="text-2xl font-mono font-bold">${imp.matricola || '---'}</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-5 bg-slate-50 rounded-2xl border border-slate-100 space-y-2 text-xs">
                        <span class="block text-[10px] font-black text-blue-600 uppercase">Responsabili</span>
                        <p>Commerciale: <b>${imp.venditore} - ${db.mappature.comm[imp.venditore] || ''}</b></p>
                        <p>Giro: <b>${imp.giro} - ${db.mappature.giri[imp.giro] || ''}</b></p>
                    </div>
                    <div class="p-5 rounded-2xl border ${semGG > 180 ? 'bg-red-50 border-red-100 text-red-900' : 'bg-blue-50 border-blue-100 text-blue-900'} space-y-1">
                        <span class="block text-[10px] font-black uppercase opacity-60">Visite</span>
                        <p class="text-xs">Mese Sem: <b>${imp['mese sem'] || '---'}</b></p>
                        <p class="text-xs font-bold">Ultima: ${formatDate(excelToDate(imp['ult sem']))} [${semGG || '---'} gg]</p>
                    </div>
                    <div class="p-5 bg-amber-50 rounded-2xl border border-amber-100 text-amber-900">
                        <span class="block text-[10px] font-black uppercase opacity-60">Visita Ente</span>
                        <p class="text-xs font-bold">Ultima: ${formatDate(excelToDate(imp['utl vp']))}</p>
                        <p class="text-[10px] uppercase font-bold opacity-60">Da ${vpGG || '---'} giorni</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-3xl border border-slate-200 space-y-6">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center">
                        <div class="border-r"><span class="text-slate-400 font-bold uppercase text-[9px]">Manut.</span><p class="text-2xl font-black text-blue-600">${imp.manut || 'SA'}</p></div>
                        <div class="border-r"><span class="text-slate-400 font-bold uppercase text-[9px]">T. Cliente</span><p class="text-2xl font-black text-slate-700">${imp['tipo cliente'] || 'P'}</p></div>
                        <div><span class="text-slate-400 font-bold uppercase text-[9px]">Periodo</span><p class="text-xl font-bold text-slate-800">${imp.periodicit√† || '180'} gg</p></div>
                    </div>
                    <div class="pt-4 border-t">
                        <span class="text-slate-400 font-bold uppercase text-[9px]">Cliente</span>
                        <p class="text-lg font-black text-slate-800">${imp.Cliente || '---'}</p>
                        <p class="text-xs text-blue-600 font-bold">Amm: ${imp.Amministratore || '---'}</p>
                        <div class="mt-4 p-4 bg-slate-50 rounded-xl italic text-xs text-slate-600">Note: ${imp.note || 'Nessuna nota'}</div>
                    </div>
                </div>

                <div class="space-y-4">
                    <h4 class="text-sm font-black text-slate-900 uppercase">Ultime Annotazioni</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${ann.length ? ann.map(a => `<div class="p-4 bg-slate-50 rounded-2xl text-xs border border-slate-100"><div class="flex justify-between font-black text-blue-600 mb-2"><span>${a.giorno_ann}/${a.mese_ann}/${a.anno_ann}</span><span class="text-slate-400">üë®‚Äçüîß ${a.tecnico_ann || ''}</span></div><p class="text-slate-700">${a.note || '---'}</p></div>`).join('') : '<p class="text-xs text-slate-300 italic">Nessun dato registrato</p>'}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-5 border border-slate-200 rounded-2xl shadow-sm">
                        <h4 class="text-[10px] font-black text-slate-400 uppercase mb-3">Verbali PDF</h4>
                        <div class="space-y-1">${verb.map(v => `<div class="text-[10px] font-bold text-red-700 bg-red-50 p-1 rounded border border-red-100 truncate">${v['NOME FILE']}</div>`).join('') || '---'}</div>
                    </div>
                    <div class="bg-white p-5 border border-slate-200 rounded-2xl shadow-sm">
                        <h4 class="text-[10px] font-black text-emerald-600 uppercase mb-3">Archivio DC</h4>
                        <div class="space-y-2">${dcList.map(d => `<div class="flex justify-between items-center bg-emerald-50 p-1.5 rounded-lg border border-emerald-100 text-[9px] font-bold"><span>PR. ${d['N¬∞  PRATICA ARCHIVIO']}</span><button onclick="event.stopPropagation(); showDcInfo(${d.idx})" class="bg-emerald-600 text-white px-2 py-0.5 rounded">INFO</button></div>`).join('') || 'Nessuna DC'}</div>
                    </div>
                    <div class="bg-white p-5 border border-slate-200 rounded-2xl shadow-sm">
                        <h4 class="text-[10px] font-black text-amber-600 uppercase mb-3">Commesse</h4>
                        <div class="space-y-2">${commList.map(c => `<div class="flex justify-between items-center bg-amber-50 p-1.5 rounded-lg border border-amber-100 text-[9px] font-bold"><span>${c['Numero Commessa']}</span><button onclick="event.stopPropagation(); showCommessaInfo(${c.idx})" class="bg-amber-600 text-white px-2 py-0.5 rounded">INFO</button></div>`).join('') || 'Nessuna Commessa'}</div>
                    </div>
                </div>
            </div>`;
    }

    initDatabase();
</script>