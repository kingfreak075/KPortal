<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ricerca Impianti Mobile</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- STILI BASE E VARIABILI --- */
        :root {
            --primary-color: #1b5e20;
            --secondary-color: #4caf50;
            --bg-gradient: linear-gradient(135deg, #a5d6a7 0%, #66bb6a 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 4px 15px rgba(0,0,0,0.15);
            --info-blue: #2196f3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-gradient);
            color: #333;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding-bottom: 60px;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            font-size: 1.5rem;
            margin: 10px 0 20px 0;
            background: rgba(255,255,255,0.6);
            padding: 10px;
            border-radius: 8px;
        }

        h2 {
            color: var(--primary-color);
            font-size: 1.2rem;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 5px;
            margin-bottom: 15px;
        }

        h3 {
            color: var(--primary-color);
            font-size: 1.1rem;
            margin: 15px 0 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .column {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* --- STATO CARICAMENTO --- */
        #status-bar {
            text-align: center;
            padding: 10px;
            margin-bottom: 15px;
            background: #fff;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .status-loading {
            color: #e67e22;
        }

        .status-ready {
            color: var(--primary-color);
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* --- RISULTATI --- */
        .results-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-top: 15px;
        }

        .result-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #fff;
        }

            .result-item:active {
                background-color: #e8f5e9;
            }

        /* --- DETTAGLI --- */
        .scheda-item p {
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .scheda-item strong {
            color: #444;
        }

        .section-box {
            background: #f1f8e9;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            border-left: 4px solid var(--secondary-color);
        }

        .verbale-link {
            display: block;
            padding: 8px;
            background: #fff;
            margin-bottom: 5px;
            border-radius: 4px;
            text-decoration: none;
            color: var(--info-blue);
            font-size: 0.85rem;
            border: 1px solid #e0e0e0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .commessa-item {
            font-size: 0.85rem;
            padding: 6px 0;
            border-bottom: 1px dashed #ccc;
        }

        .badge-tipo {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
            margin-right: 5px;
        }

        .badge-semestrale {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge-appuntamento {
            background: #e3f2fd;
            color: #1565c0;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #333;
            color: #fff;
            text-align: center;
            padding: 8px;
            font-size: 0.7rem;
            z-index: 1000;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>🔍 Ricerca Impianti</h1>

        <div id="status-bar" class="status-loading">
            <div class="loader"></div>
            <span>Caricamento Database...</span>
        </div>

        <div class="column">
            <form id="searchForm">
                <input type="text" id="query" placeholder="Codice Impianto o Indirizzo" autocomplete="off">
                <button type="submit" class="btn" style="margin-top:10px;">CERCA</button>
            </form>
            <div id="results" class="results-container"></div>
        </div>

        <div class="column" id="dettagli-container" style="display:none;">
            <h2>Scheda Impianto</h2>
            <div id="impiantoDetails" class="scheda-item"></div>

            <div id="sezione-verbali" class="section-box">
                <h3>📄 Verbali</h3>
                <div id="lista-verbali"></div>
            </div>

            <div id="sezione-commesse" class="section-box" style="border-left-color: var(--info-blue);">
                <h3>🔧 Commesse</h3>
                <div id="lista-commesse"></div>
            </div>
<div id="sezione-archivio" class="section-box" style="border-left-color: #ff9800;">
                <h3>📄 Archivio DC</h3>
                <div id="lista-archivio"></div>
            </div>
            <button onclick="document.getElementById('dettagli-container').style.display='none'; window.scrollTo(0,0);" class="btn" style="margin-top:20px; background:#666;">CHIUDI</button>
        </div>
    </div>

    <div class="footer"><p>ESA Mobile v1.1 - kingfreak075</p></div>

    <script>
        const GITHUB_EXCEL_URL = 'https://raw.githubusercontent.com/kingfreak075/EXA/main/DB.xlsx';
        let data = [], elencoData = [], m28Data = [], annotazioniData = [], archivioData = [], mappature = { commerciali: {}, giri: {} };
        let dbCaricato = false;

        window.onload = caricaDatabase;

        async function caricaDatabase() {
            const statusBar = document.getElementById('status-bar');
            try {
                const response = await fetch(GITHUB_EXCEL_URL + '?t=' + new Date().getTime());
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                data = XLSX.utils.sheet_to_json(workbook.Sheets["PARCO"] || {});
                m28Data = XLSX.utils.sheet_to_json(workbook.Sheets["M28"] || {});
                elencoData = XLSX.utils.sheet_to_json(workbook.Sheets["ELENCO"] || {});
                annotazioniData = XLSX.utils.sheet_to_json(workbook.Sheets["ANNOTAZIONI"] || {});
                archivioData = XLSX.utils.sheet_to_json(workbook.Sheets["ARCHIVIO"] || {});

                if (workbook.Sheets["MAPPATURE"]) {
                    XLSX.utils.sheet_to_json(workbook.Sheets["MAPPATURE"]).forEach(row => {
                        if (row.Tipo === 'COMMERCIALE') mappature.commerciali[row.Codice] = row.Nome;
                        else if (row.Tipo === 'GIRO') mappature.giri[row.Codice] = row.Nome;
                    });
                }

                dbCaricato = true;
                statusBar.innerHTML = '✅ Database Pronto';
                statusBar.className = 'status-ready';
            } catch (e) {
                statusBar.innerHTML = '❌ Errore Caricamento';
            }
        }

        document.getElementById('searchForm').addEventListener('submit', e => {
            e.preventDefault();
            const q = document.getElementById('query').value.toLowerCase().trim();
            if (q.length < 3) return alert("Inserisci almeno 3 caratteri");
            const res = data.filter(i => String(i.impianto).toLowerCase().includes(q) || String(i['Indirizzo impianto']).toLowerCase().includes(q));
            mostraRisultati(res);
        });

        function mostraRisultati(results) {
            const container = document.getElementById('results');
            document.getElementById('dettagli-container').style.display = 'none';

            if (results.length === 0) {
                container.innerHTML = '<div style="padding:15px; text-align:center;">Nessun risultato trovato.</div>';
                return;
            }

            let html = '';
            results.slice(0, 50).forEach(item => {
                const giroText = (item.giro == 77 || item.giro == 88 || item.giro == 99)
                    ? `<span style="color:red; font-weight:bold;">DISDETTA</span>`
                    : (mappature.giri[item.giro] || item.giro || 'N/A');

                // MODIFICA QUI: Aggiunta Località impianto
                html += `
                <div class="result-item" onclick="apriDettaglio('${item.impianto}')">
                    <div style="font-weight:bold; font-size:1.1rem; margin-bottom:4px;">${item.impianto} <span style="font-weight:normal; font-size:0.9rem; color:#666;">(Matr. ${item.matricola || '-'})</span></div>
                    <div style="font-size:0.95rem; margin-bottom:4px;">📍 ${item['Indirizzo impianto']} - ${item['Località impianto'] || ''}</div>
                    <div style="font-size:0.85rem; color:#555;">👤 ${item.venditore || 'N/D'} | 🔄 ${giroText}</div>
                    <div style="margin-top:8px; text-align:right;">
                        <span style="color:var(--secondary-color); font-weight:bold; font-size:0.9rem;">Tocca per dettagli ></span>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }
        function excelDateToJS(ed) { return ed ? new Date(Math.round((ed - 25569) * 86400 * 1000)) : null; }
        function fmt(ed) {
            const d = excelDateToJS(ed);
            return d ? `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}` : 'N/A';
        }

        function apriDettaglio(cod) {
            const imp = data.find(x => x.impianto == cod);
            if (!imp) return;

            // Dati Base
            document.getElementById('impiantoDetails').innerHTML = `
                    <p style="font-size:1.2rem; text-align:center; color:var(--primary-color);"><strong>${imp.impianto}</strong></p>
                    <p><strong>📍 Indirizzo:</strong> ${imp['Indirizzo impianto']} ${imp['Località impianto'] || ''}</p>
                    <p><strong>👤 Cliente:</strong> ${imp.Cliente || '-'}</p>
                    <p><strong>📅 Ult. Sem:</strong> ${fmt(imp['ult sem'])}</p>
                    <p><strong>🛠️ Ult. VP:</strong> ${fmt(imp['utl vp'])}</p>
                    <p><strong>🔄 Giro:</strong> ${mappature.giri[imp.giro] || imp.giro || '-'}</p>
                    <p><strong>📝 Note:</strong> ${imp.note || 'Nessuna'}</p>
                `;

            // Verbali (da ELENCO)
            const verbali = elencoData.filter(v => v.IMPIANTO == cod);
            document.getElementById('lista-verbali').innerHTML = verbali.length ? verbali.map(v => `
                    <a class="verbale-link" href="https://otiselevatoreur.sharepoint.com/:f:/r/teams/ESABologna/Shared%20Documents/General/Uff_Tecnico/KING/PROGETTO%20VERBALI/VERBALO_DOWN_ARXC/${v['NOME FILE']}" target="_blank">
                        📄 ${v['NOME FILE']}
                    </a>
                `).join('') : '<p class="placeholder">Nessun verbale trovato.</p>';

            // Commesse (da M28)
            const commesse = m28Data.filter(c => c["ID Imp."] == cod);
            document.getElementById('lista-commesse').innerHTML = commesse.length ? commesse.map(c => `
                    <div class="commessa-item">
                        <strong>${c["Numero Commessa"]}</strong> - ${fmt(c["Data commessa"])}<br>
                        <small>${c["Stato comm."]} | ${c["Tipo"] || ''}</small>
                    </div>
                `).join('') : '<p class="placeholder">Nessuna commessa.</p>';

            document.getElementById('dettagli-container').style.display = 'block';
            document.getElementById('dettagli-container').scrollIntoView({ behavior: 'smooth' });

// Archivio DC (da ARCHIVIO)
            const codImpianto = String(cod).trim();
            const recordsArchivio = archivioData.filter(r => {
                const esa = String(r['N°IMPIANTO ESA'] || '').trim();
                return esa === codImpianto || esa === codImpianto.replace(/^0+/, '');
            });

            document.getElementById('lista-archivio').innerHTML = recordsArchivio.length ? recordsArchivio.map(r => `
                <div class="commessa-item" style="background: #fffde7; padding: 5px; border-radius: 4px; margin-bottom: 5px;">
                    <strong>Pratica: ${r['N°  PRATICA ARCHIVIO'] || 'N/D'}</strong><br>
                    <small>Richiesta: ${r['DOC RICHIESTI'] || 'N/D'} (${fmt(r['Column12'])})</small><br>
                    <small>Consegna: ${r['DOCS PER CLIENTE CONSEGNATI'] || 'N/D'} (${fmt(r['Column17'])})</small>
                </div>
            `).join('') : '<p class="placeholder">✅ Nessuna Dichiarazione presente</p>';

            document.getElementById('dettagli-container').style.display = 'block';
            document.getElementById('dettagli-container').scrollIntoView({ behavior: 'smooth' });


        }
    </script>
</body>

</html>
